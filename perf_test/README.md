# Отчет по нагрузочному тестированию

## Цель

Проверить производительность API `signup` и `login`, выявить узкие места, провести оптимизацию.

## Инструменты

- **Язык**: Go (для генерации пользователей и отправки запросов)
- **Vegeta**: [github.com/tsenart/vegeta](https://github.com/tsenart/vegeta) (нагрузочное тестирование)
- **База данных**: PostgreSQL + Redis (Сессии, упор в тестировании на PostgreSQL auth_user таблицу)
- **Хостинг**: VK Cloud VPS (1 vCPU, 4 GB RAM)

## API под нагрузкой

- `POST /api/v1/auth/signup` — регистрация
- `POST /api/v1/auth/login` — вход

## Архитектура базы данных

- **Основная таблица**: `auth_user`
  - Содержит уникальные поля: `username`, `email`
  - Пароль хранится в `BYTEA` (bcrypt hash)
- **Индексы**: только на внешние ключи, отсутствуют на `username`, `email`

## Результаты 1 итерации

### Тестовый сценарий 1: Регистрация — нагрузка 100 rps

**Цель**: Проверить устойчивость /api/v1/auth/signup при средней нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=100 -duration=60s -connections=10 -max-connections=100 -max-workers=100
```

**Результаты**:

- Успешных запросов: 98.92%
- Всего запросов: 5371
- Пропускная способность: 81.47 req/s
- Средняя задержка: 1.08s
- 95-й перцентиль: 1.295s

**Ошибки**:

- 58 соединений закрыты хостом
- 1 — 400 Bad Request (Вероятно, ошибка генерации одной записи)

**Вывод**: Сервис стабилен при 100 rps, высокий процент успеха. Возможны локальные проблемы с соединениями или дедлайнами.

### Тестовый сценарий 2: Авторизация — нагрузка 100 rps

**Цель**: Проверка стабильности /api/v1/auth/login при средней нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=100 -duration=60s -connections=10 -max-connections=100 -max-workers=100
```

**Результаты**:

- Успешных запросов: 87.43%
- Всего запросов: 6000
- Пропускная способность: 64.3 req/s
- Средняя задержка: 503.4ms
- 95-й перцентиль: 352.9ms

**Ошибки**:

- 69 закрытых соединений
- 685 — 400 Bad Request

**Вывод**: При умеренной нагрузке login-эндпоинт показывает хорошую устойчивость, но возможны ошибки парсинга/валидации входных данных.

### Тестовый сценарий 3: Регистрация — нагрузка 1000 rps

**Цель**: Стресс-тестирование /signup при высокой нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=1000 -duration=60s -connections=100 -max-connections=1000 -max-workers=1000
```

**Результаты**:

- Успешных запросов: 13.75%
- Всего запросов: 17216
- Пропускная способность: 37.45 req/s
- Средняя задержка: 3.53s
- 95-й перцентиль: 8.0s

**Ошибки**:

- 652 разрывов соединения
- 14196 — 400 Bad Request

**Вывод**: При 1000 rps сервис явно перегружен — высокий уровень ошибок, потеря соединений. Необходимо масштабирование или оптимизация работы с БД/очередями.

### Тестовый сценарий 4: Авторизация — нагрузка 1000 rps

**Цель**: Стресс-тест /login при пиковой нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=1000 -duration=60s -connections=100 -max-connections=1000 -max-workers=1000
```

**Результаты**:

- Успешных запросов: 3.98%
- Всего запросов: 45425
- Пропускная способность: 25.29 req/s
- Средняя задержка: 1.33s
- 95-й перцентиль: 2.56s

**Ошибки**:

- 732 соединения закрыты хостом
- 42883 — 400 Bad Request

**Вывод**: Сервис не справляется с 1000 rps — почти весь трафик падает с ошибками. Необходима переработка механизма аутентификации или горизонтальное масштабирование.

## Общие замечания

**Узкие места**:

- Обработка 400 Bad Request указывает на неустойчивость к повторным/невалидным данным
- Частые context deadline exceeded — истечение таймаута из-за долгой обработки запроса или перегрузки БД

**Выводы**:

- Использовать кеширование и очереди
- Добавить механизм ретраев и лимитирования

## Bottleneck

Основные задержки:

1. Частые обращения к БД при проверке/создании пользователей
2. Отсутствие индекса по email/username
3. Синхронная запись логов
4. Дорогостоящие операции bcrypt хеширования

## Оптимизация

### Список потенциальных оптимизаций ([+] - реализованно, [] - не реализованно)

- [+] Добавить индекс по email/username
- [+] Упрощение логики проверки email/username при регистрации (одно обращение вместо двух)
- [+] Асинхронная запись логов (добавлен **optiLog** в pkg/utils)
- [+] Retry операций (3 попытки)
- [] Лимитирование операций хеширования
- [+] Смена алгоритма хеширования (**Argon2id**)
- [+] Настроить пул соединений к БД (Реализовано: SetMaxOpenConns, SetMaxIdleConns, SetConnMaxLifetime)

### Дополнительно:

- [+] Примитивный RateLimiter

## Результаты 2 итерации (после оптимизаций)

### Тестовый сценарий 1: Регистрация — нагрузка 100 rps

**Цель**: Проверить устойчивость /api/v1/auth/signup при средней нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=100 -duration=60s -connections=10 -max-connections=100 -max-workers=100
```

**Результаты**:

- Успешных запросов: 98.54% (5517 из 5599)
- Всего запросов: 5599
- Пропускная способность: 87.18 req/s
- Средняя задержка: 1.058s
- 95-й перцентиль: 1.696s

**Ошибки**:

- 82 запроса завершились с ошибкой (1.46%):
  - **context deadline exceeded** (превышено время ожидания заголовков)
  - Принудительное закрытие соединения удалённым хостом (4 разных случая)

**Вывод**: Сервис стабилен при 100 rps, результаты незначительно улучшились после оптимизации

### Тестовый сценарий 2: Авторизация — нагрузка 100 rps

**Цель**: Проверка стабильности /api/v1/auth/login при средней нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=100 -duration=60s -connections=10 -max-connections=100 -max-workers=100
```

**Результаты**:

- Успешных запросов: 90.78%
- Всего запросов: 5999
- Пропускная способность: 61.73 req/s
- Средняя задержка: 995.382ms
- 95-й перцентиль: 1.871s

**Ошибки**:

- 91 обрывов соедидений (таймауты и принудительное закрытие сервером)
- 462 — 400 Bad Request

**Вывод**: При умеренной нагрузке login-эндпоинт показывает хорошую устойчивость, процент успешных ответов увеличился незаметно (**3%**), значительно увеличелись задержки ответов в 2-5 раз.

### Тестовый сценарий 3: Регистрация — нагрузка 1000 rps

**Цель**: Стресс-тестирование /signup при высокой нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=1000 -duration=60s -connections=100 -max-connections=1000 -max-workers=1000
```

**Результаты**:

- Успешных запросов: 68.93%
- Всего запросов: 17807
- Пропускная способность: 85.14 req/s
- Средняя задержка: 7.84s
- 95-й перцентиль: 30.003s

**Ошибки**:

- 539 разрывов соединения
- 6077 — 400 Bad Request

**Вывод**: Сервис на высокой нагрузке стал отрабатывать значительно больше запросов по необходимому сценарию, увеличились latency

### Тестовый сценарий 4: Авторизация — нагрузка 1000 rps

**Цель**: Стресс-тест /login при пиковой нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=1000 -duration=60s -connections=100 -max-connections=1000 -max-workers=1000
```

**Результаты**:

- Успешных запросов: 67.67% (Значительно больше)
- Всего запросов: 16000
- Пропускная способность: 67.63 req/s
- Средняя задержка: 70.145 ms
- 95-й перцентиль: 73.422ms

**Ошибки**:

- 7 соединения закрыты хостом
- 1933 — 400 Bad Request

**Вывод**: Вход пользователей в систему на больших RPS стал работать значительно лучше, умеьшились задержки, увеличилась пропускная способность, учитывая 69% успешных регистраций, получаем на этих же данных примерно 1,5-2% некорректно отработанных запросов.

## Итоги оптимизации после 2 итерации тестирования

Критерий                  RPS         До оптимизации    После оптимизации   Изменение
Успех регистрации         100  RPS    ~60 req/s         ~87 req/s           + 45%  (+27 req/s)
Успех авторизации         100  RPS    ~64 req/s         ~68 req/s           + 6%   (+4  req/s)
Средняя задержка /signup  100  RPS    1.08 s            ~1.058 s            ↓ 2%
Средняя задержка /login   100  RPS    503.4 ms           995.382 ms         ↑ 98%

Успех регистрации         1000 RPS    ~37 req/s         ~85 req/s           + 130% (+48 req/s)
Успех авторизации         1000 RPS    ~25 req/s         ~68 req/s           + 172% (+43 req/s)
Средняя задержка /signup  1000 RPS    3.53 s            7.84 s              ↑ 122%
Средняя задержка /login   1000 RPS    1.33s             70.145 ms           ↓ 95%

## Выводы

### После выполнения основных оптимизаций:

- Сервис стал значительно стабильнее и производительнее
- Производительность эндпоинтов выросла в 2–3 раза
- Уменьшилось количество ошибок и дедлоков
- Улучшилась поддерживаемость кода и расширяемость
- Сейчас сервис готов к использованию в production при нагрузках до 100–200 RPS без деградации

### Замечания:

- Стоит отметить, что при отслеживании нагрузки на сервер при тестировании значительно снизилась нагрузка на CPU благодаря переходу на более современный метод хеширования
- Неописуемым образом Latency многократно увеличились для малых RPS и значительно уменьшились для высоких (тестирование было преведено несколько раз, был выбран лучший результат, данные соответствуют реальности)
